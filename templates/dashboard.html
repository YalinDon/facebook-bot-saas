<!-- templates/dashboard.html -->

{% extends "base.html" %}
{% block title %}Tableau de bord{% endblock %}

{% block content %}
    <h1 class="mb-4">Bienvenue, {{ current_user.first_name }} {{ current_user.last_name }} !</h1>

    {# On définit nos variables de statut pour les réutiliser facilement #}
    {% set is_subscribed = current_user.subscription_status == 'active' %}
    {% set is_in_trial = current_user.trial_ends_at and current_user.trial_ends_at > now() %}
    {% set trial_ended = current_user.trial_ends_at and current_user.trial_ends_at <= now() %}
    {% set has_never_started_trial = current_user.trial_ends_at is none %}

    <!-- Bloc de statut de l'abonnement -->
    <div class="card mb-4">
        <div class="card-body">
            
            {# CAS SPÉCIAL : Si l'utilisateur est un Super Admin #}
            {% if current_user.is_superadmin %}
                <h5 class="card-title">Statut Administrateur</h5>
                <div class="alert alert-success">
                    <p class="mb-0">Vous êtes connecté en tant que <strong>Super Administrateur</strong>.</p>
                    <p class="mb-0 small text-muted">Vous avez un accès illimité à toutes les fonctionnalités pour les tests et la maintenance.</p>
                </div>

            {# CAS NORMAL : Pour tous les autres utilisateurs #}
            {% elif is_subscribed %}
                <h5 class="card-title">Statut de l'abonnement</h5>
                {% if current_user.subscription_plan == 'pro' %}
                    <p class="card-text">Vous avez un abonnement <strong class="text-success">Actif (Forfait Pro)</strong>.</p>
                {% elif current_user.subscription_plan == 'business' %}
                    <p class="card-text">Vous avez un abonnement <strong class="text-success">Actif (Forfait Business)</strong>.</p>
                {% else %}
                    <p class="card-text">Vous avez un abonnement <strong class="text-success">Actif</strong>.</p>
                {% endif %}
                {% if current_user.subscription_expires_at %}
                    <p class="card-text text-muted small">Votre accès est valide jusqu'au {{ current_user.subscription_expires_at.strftime('%d/%m/%Y') }}.</p>
                {% endif %}
                {% if current_user.subscription_provider == 'stripe' %}
                    <form action="{{ url_for('main.manage_subscription') }}" method="POST" style="margin-top: 10px;">
                        <button type="submit" class="btn btn-secondary">Gérer mon abonnement</button>
                    </form>
                {% elif current_user.subscription_provider == 'fedapay' %}
                    <a href="{{ url_for('main.manage_fedapay_subscription') }}" class="btn btn-secondary mt-2">Modifier l'abonnement</a>
                {% endif %}
            
            {% elif is_in_trial %}
                <h5 class="card-title">Période d'Essai</h5>
                <p class="card-text">Vous êtes actuellement en <strong class="text-primary">période d'essai</strong>. Il vous reste : <strong>{{ (current_user.trial_ends_at - now()).days }}j {{ ((current_user.trial_ends_at - now()).seconds // 3600) }}h</strong>.</p>
                <p class="text-muted small">Pendant l'essai, vous ne pouvez connecter qu'une seule page.</p>
                <a href="{{ url_for('main.pricing') }}" class="btn btn-success">Passer à l'abonnement</a>

            {% elif trial_ended %}
                <div class="alert alert-warning text-center">
                    <h4 class="alert-heading">Période d'essai terminée</h4>
                    <p>Pour continuer à utiliser le service, veuillez choisir un forfait.</p>
                    <a href="{{ url_for('main.pricing') }}" class="btn btn-success">Voir les forfaits</a>
                </div>

            {% elif has_never_started_trial %}
                <div class="alert alert-info text-center">
                    <h4 class="alert-heading">Commencez dès maintenant !</h4>
                    <p>Démarrez votre essai gratuit de 48h ou abonnez-vous directement pour débloquer toutes les fonctionnalités.</p>
                    <form action="{{ url_for('main.start_trial') }}" method="POST" class="d-inline-block me-2"><button type="submit" class="btn btn-primary">Démarrer mon essai gratuit (48h)</button></form>
                    <a href="{{ url_for('main.pricing') }}" class="btn btn-success d-inline-block">S'abonner directement</a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Bloc de gestion des pages et de l'historique (visible si abonné, en essai, OU SUPERADMIN) -->
    {% if is_subscribed or is_in_trial or current_user.is_superadmin %}
        <div class="card mb-4">
            <div class="card-header">
                <h2>Gestion des Pages Facebook</h2>
            </div>
            <div class="card-body">
                {% if not pages %}
                    <div class="text-center p-3">
                        <p><strong>Étape suivante :</strong> Connectez votre page Facebook pour que le bot puisse commencer à publier.</p>
                        <a href="{{ url_for('main.facebook_login') }}" class="btn btn-primary btn-lg">Connecter avec Facebook</a>
                    </div>
                {% else %}
                    <ul class="list-group">
                    {% for page in pages %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ page.page_name }}</strong><br>
                                <small>Statut : {% if page.is_active %}<span class="badge bg-success">Actif</span>{% else %}<span class="badge bg-secondary">Inactif</span>{% endif %}</small>
                            </div>
                            <div>
                                <form action="{{ url_for('main.toggle_page_active', page_id=page.id) }}" method="POST" class="d-inline-block me-1"><button type="submit" class="btn btn-sm btn-outline-secondary">{% if page.is_active %} Désactiver {% else %} Activer {% endif %}</button></form>
                                <form action="{{ url_for('main.delete_page', page_id=page.id) }}" method="POST" class="d-inline-block"><button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Êtes-vous sûr ?');">Supprimer</button></form>
                            </div>
                        </li>
                    {% endfor %}
                    </ul>
                    <div class="mt-3">
                        {% if (is_subscribed and current_user.subscription_plan == 'business') or (is_subscribed and current_user.subscription_plan == 'pro' and pages|length < 3) or (is_in_trial and pages|length < 1) or current_user.is_superadmin %}
                            <a href="{{ url_for('main.facebook_login') }}" class="btn btn-primary">Connecter une autre page</a>
                        {% elif is_subscribed and current_user.subscription_plan == 'pro' and pages|length >= 3 %}
                            <p class="text-muted">Vous avez atteint la limite de 3 pages de votre forfait Pro.</p>
                        {% elif is_in_trial and pages|length >= 1 %}
                            <p class="text-muted">Passez à un abonnement pour connecter des pages supplémentaires.</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- SECTION HISTORIQUE UNIFIÉE ET AMÉLIORÉE -->
        <div class="card">
            <div class="card-header">
                <h2>Historique des Dernières Publications</h2>
            </div>
            <div class="card-body">
                {% if history_items %}
                    <div class="list-group">
                    {% for item in history_items %}
                        <div class="list-group-item list-group-item-action flex-column align-items-start">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">
                                    {% if item.type == 'news' %}
                                        <i class="bi bi-newspaper me-2 text-primary"></i>Actualité
                                    {% else %}
                                        <i class="bi bi-trophy-fill me-2 text-warning"></i>Publication de Score
                                    {% endif %}
                                </h5>
                                <small class="text-muted">{{ item.timestamp.strftime('%d/%m/%Y à %H:%M') }}</small>
                            </div>
                            
                            {% if item.type == 'news' %}
                                <p class="fw-bold mt-2">{{ item.title }}</p>
                            {% endif %}
                            
                            {% set content_id = "content-" ~ loop.index %}
                            {% set preview_id = "preview-" ~ loop.index %}
                            {% set toggle_id = "toggle-" ~ loop.index %}

                            {% if item.content and item.content|length > 250 %}
                                <div id="{{ preview_id }}">
                                    <p class="mb-1 mt-2" style="white-space: pre-wrap;">{{ item.content[:250] }}...</p>
                                    <a id="{{ toggle_id }}" href="javascript:void(0)" onclick="toggleContent('{{ preview_id }}', '{{ content_id }}', '{{ toggle_id }}')" class="btn btn-link btn-sm p-0">Lire la suite</a>
                                </div>
                                <div id="{{ content_id }}" style="display: none;">
                                    <p class="mb-1 mt-2" style="white-space: pre-wrap;">{{ item.content }}</p>
                                    <a href="javascript:void(0)" onclick="toggleContent('{{ preview_id }}', '{{ content_id }}', '{{ toggle_id }}')" class="btn btn-link btn-sm p-0">Réduire</a>
                                </div>
                            {% elif item.content %}
                                <p class="mb-1 mt-2" style="white-space: pre-wrap;">{{ item.content }}</p>
                            {% else %}
                                <p class="text-muted fst-italic mt-2">Contenu non disponible.</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">Aucune publication n'a encore été effectuée.</p>
                {% endif %}
            </div>
        </div>
    {% endif %}

{% endblock %}